<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="author" content="ATopSoft" />
<meta name="copyright" content="Copyright &copy; 2004-2007, ATopSoft, All Rights Reserved." />
<meta name="rating" content="Safe For Kids" />
<meta name="keywords" lang="en" content="meta key" />
<meta name="description" content="meta desc" />

<title>Win32 CodeHook -- Tutorials</title>
<style type="text/css">@import url('page.css');</style>
<link rel="stylesheet" type="text/css" href="page.css" />
</head>


<body>
<div class="header">
</div>
<div class="container">
	<div class="mainbox">
		 <div class="nav"><ul>
<li><a href="index.html">Introduction</a></li>
<li><a href="start.html">Get start</a></li>
<li><a href="api-icodehook.html">Interface - ICodeHook</a></li>
<li><a href="api-icodehookhelper.html">Interface - ICodeHookHelper</a></li>
<li><a href="api-idirectcodehook.html">Interface - IDirectCodeHook</a></li>
<li><a href="api-ierrorcodehook.html">Interface - IErrorCodeHook</a></li>
<li><a href="compare-raw-advanced-mode.html">Comparison of raw mode and advanced mode</a></li>
<li><a href="tutorial.html">Tutorials</a></li>
<li><a href="faq.html">FAQ</a></li>
<li><a href="support.html">Support</a></li>
<li><a href="version.html">Credits and Versions</a></li>

</ul>

		 </div>
		 <div class="content">This document consists of following tutorials: <br />
<ul>
<li><a href="#get-root-intf">Tutorial 1: Get the root interface</a> </li>
<li><a href="#low-level-hook">Tutorial 2: Low level (raw mode) hook</a> </li>
<li><a href="#advanced-hook">Tutorial 3: Advanced hook</a> </li>
<li><a href="#write-hook-for-raw-mode">Tutorial 4: Write hook function for raw mode hook</a> </li>
<li><a href="#write-hook-for-advanced-mode">Tutorial 5: Write hook function for advanced mode hook</a> </li>
</ul>

<a id="get-root-intf"></a>
<div class="plist">
<h3>Tutorial 1: Get the root interface: </h3>
<h5>Get the root interface in Delphi</h5>
Dynamically link to CHook.dll <br />
<pre>
uses CodeHookIntf;

var
  GCodeHook: ICodeHook;
  GCodeHookHelper: ICodeHookHelper;

procedure InitWithDll;
begin
  InitCodeHookDLL('the path to the dll\CHook.dll');
  GetCodeHook(GCodeHook);
  GCodeHook.GetCodeHookHelper(GCodeHookHelper);
end;
</pre>

Static link to the source code (no DLL required) <br />
<pre>
uses CodeHook;

var
  GCodeHook: ICodeHook;
  GCodeHookHelper: ICodeHookHelper;

procedure InitWithoutDll;
begin
  GCodeHook := GetCodeHookIntf;
  GCodeHook.GetCodeHookHelper(GCodeHookHelper);
end;
</pre>

<h5>Get the root interface in C++</h5>
Dynamically link to CHook.dll <br />
<pre>
#include "codehook.h"

ICodeHook * codehook;
ICodeHookHelper *helper;

	CodeHookDynamicLoader::InitLoader("the path to the dll\CHook.dll");
	GetCodeHook((void **)&codehook);
	codehook->GetCodeHookHelper(&helper);
</pre>

For Borland C++ users, there is also a CodeHook_bc.lib which can be static linked instead of use CHook.dll. <br />
The lib for VC is lacked because I have not found any usable tool to convert the lib from OMF format to COFF. <br />

</div>


<a id="low-level-hook"></a>
<div class="plist">
<h3>Tutorial 2: Low level hook: </h3>
<h5>Step 1: Get interface ICodeHook.</h5>
See tutorial 1.

<h5>Step 2: Use ICodeHook.Hook to install the hook.</h5>

<h5>Step 3: After done, use ICodeHook.Unhook to uninstall the hook.</h5>
</div>

<a id="advanced-hook"></a>
<div class="plist">
<h3>Tutorial 3: Advanced hook: </h3>
<h5>Step 1: Get interface ICodeHook.</h5>
See tutorial 1.

<h5>Step 2: Use ICodeHook.AdvancedHook to install the hook.</h5>

<h5>Step 3: After done, use ICodeHook.AdvancedUnhook to uninstall the hook.</h5>

Beside ICodeHook, ICodeHookHelper makes it more easier to do advanced hook.
</div>


<a id="write-hook-for-raw-mode"></a>
<div class="plist">
<h3>Tutorial 4: Write hook function for raw mode hook</h3>
The only rule to write hook function for raw mode hook is the prototype of the hook function must be exactly same as the target function. <br />
Usually you can find the prototype of the target function from the SDK header file, so you can just copy the prototype to your source file and them rename it to the hook name. <br />
For example, if you want to hook the Windows API MessageBox. <br />
According to Windows SDK, its prototype is, <br />
<pre>
WINUSERAPI
int
WINAPI
MessageBoxA(
    IN HWND hWnd,
    IN LPCSTR lpText,
    IN LPCSTR lpCaption,
    IN UINT uType);
</pre>
We can just simple declare the hook function as, <br />
<pre>
WINUSERAPI
int
WINAPI
NewMessageBoxA(
    IN HWND hWnd,
    IN LPCSTR lpText,
    IN LPCSTR lpCaption,
    IN UINT uType);
</pre>
We only need to rename MessageBoxA to NewMessageBoxA, and keep others as it is. <br />
<br />

This is also true for Delphi users, you can find the declaration of MessageBoxA in Windows.pas and just copy and rename it. <br />
The hook function in Delphi will look like, <br />
<pre>
function NewMessageBoxA(hWnd: HWND; lpText, lpCaption: PAnsiChar; uType: UINT): Integer; stdcall;
</pre>

</div>


<a id="write-hook-for-advanced-mode"></a>
<div class="plist">
<h3>Tutorial 5: Write hook function for advanced mode hook</h3>
We need to discuss this topic under two slightly different situation. <br />
<br />

<h5>Situation 1, there are no extra parameters be passed.</h5>
If you use ICodeHook.AdvancedHook with AExtraParamCount equals to 0, or use ICodeHookHelper.HookWithGlobalMethod or ICodeHookHelper.HookWithObjectMethod to make the hooking, there are no extra parameters be passed to the hook function. <br />
Under this situation, the hook function is simple and fixed prototype. <br />
The prototype is, <br />
Delphi syntax:
<pre>function HookCallback(AHandle: TCodeHookHandle; AParams: PCodeHookParamAccessor): Cardinal; CallingConvention;
</pre>
C++ syntax:
<pre>DWORD CallingConvention HookCallback(TCodeHookHandle AHandle, PDWORD AParams);
</pre>

The CallingConvention is how you declare HookCallback. You can choose any calling convention that supported by Win32 CodeHook, such as stdcall, cdecl, register call, etc. <br />

<br />

<h5>Situation 2, there are extra parameters be passed.</h5>
If you use ICodeHook.AdvancedHook with AExtraParamCount greater than 0, or use ICodeHookHelper.HookWithGlobalMethodExtra or ICodeHookHelper.HookWithObjectMethodExtra to make the hooking, there are extra parameters be passed to the hook function. <br />
Under this situation, you only need to add the extra parameters to the prototype. <br />
Delphi syntax:
<pre>function HookCallback(AExtraParam1: Cardinal; AExtraParam2: Cardinal .. AExtraParamN:
  Cardinal; AHandle: TCodeHookHandle; AParams: PCodeHookParamAccessor): Cardinal; CallingConvention;
</pre>
C++ syntax:
<pre>
DWORD CallingConvention HookCallback(DWORD AExtraParam1, DWORD AExtraParam2 .. DWORD AExtraParamN,
	TCodeHookHandle AHandle, PDWORD AParams);
</pre>

</div>


		 </div>
	</div>
</div>
<div class="footer">Copyright &copy; 2008, Wang Qi, All Rights Reserved.
</div>
</body>
</html>
